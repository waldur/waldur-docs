include:
  - project: "waldur/waldur-pipelines"
    file: "/templates/stages.yml"
  - project: "waldur/waldur-pipelines"
    file: "/templates/test/check-merge-compatibility.yml"
  - .gitlab-ci-external-sync.yml

#Lint MD files:
#  image: registry.hpc.ut.ee/mirror/library/node:lts-alpine
#  stage: test
#  rules:
#    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
#      changes:
#        - "*.md"
#        - docs/**/*
#  before_script:
#    - npm install
#  script:
#    - node lint-markdown.mjs

Test mkdocs:
  image: registry.hpc.ut.ee/mirror/library/python:3.12
  stage: test
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  script:
    - pip install uv
    - uv sync --frozen
    - uv run mkdocs build --strict --site-dir test

.build_before_script: &build_before_script
  - echo "[+] Adding SSH keys to the home directory"
  - mkdir -p ~/.ssh
  - cat "$SSH_JENKINS_GITHUB_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
  - cat "$SSH_JENKINS_GITHUB_PUBLIC_KEY" | tr -d '\r' > ~/.ssh/id_rsa.pub
  - chmod 600 ~/.ssh/id_rsa
  - chmod 600 ~/.ssh/id_rsa.pub
  - ssh-keygen -lf ~/.ssh/id_rsa.pub
  - ssh-keyscan -H "github.com" >> ~/.ssh/known_hosts
  - git config --global user.name "$GITLAB_USER_NAME"
  - git config --global user.email "$GITLAB_USER_EMAIL"

.build_script_steps: &build_script_steps
  - git remote add github_waldur git@github.com:waldur/waldur-docs.git || true
  - git remote -v
  - pip install uv
  - uv sync --frozen
  - cd $CI_PROJECT_DIR
  - export ENABLE_PDF_EXPORT=1
  - git branch -D gh-pages || true
  - git fetch github_waldur

Build latest pages:
  image: registry.hpc.ut.ee/mirror/library/python:3.12
  stage: deploy
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
  script:
    - *build_script_steps
    - uv run mike deploy latest -p -r github_waldur -b gh-pages
  before_script: *build_before_script

Build tagged pages:
  image: registry.hpc.ut.ee/mirror/library/python:3.12
  stage: postdeploy
  rules:
    - if: '$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+$/'
  script:
    - *build_script_steps
    - uv run mike deploy $CI_COMMIT_TAG -p -r github_waldur -b gh-pages
  before_script: *build_before_script

Test Docker Compose deployment before tagging:
  stage: test
  rules:
    - if: '$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+$/'
  trigger:
    waldur/waldur-docker-compose

Test Helm deployment before tagging:
  stage: test
  rules:
    - if: '$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+$/'
  trigger:
    waldur/waldur-helm

Test changelog generation:
  image: registry.hpc.ut.ee/mirror/library/python:3.12
  stage: test
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  variables:
    CI_COMMIT_TAG_MESSAGE: "Tag message"
    CI_RELEASE_DESCRIPTION: "Release description"
    CI_COMMIT_TAG: "v10.0.0"
  script:
    - export VERSION=${CI_COMMIT_TAG}
    - PREV_TAG=$(grep -m 1 "##" docs/about/CHANGELOG.md | sed "s/## //" )
    - echo "Testing enhanced changelog generation for $VERSION (since $PREV_TAG)"
    - python3 scripts/generate-enhanced-changelog-multiRepo.py $VERSION $PREV_TAG | sed -n '/^## /,/^---$/p' | head -n -1 > /tmp/new_entry.md
    - echo "Generated enhanced changelog entry:"
    - cat /tmp/new_entry.md

Tag all repositories:
  image: registry.hpc.ut.ee/mirror/library/python:3.12
  stage: deploy
  rules:
    - if: '$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+$/'
  before_script:
    - apt-get update && apt-get install -y git
    - git config --global user.name "$GITLAB_USER_NAME"
    - git config --global user.email "$GITLAB_USER_EMAIL"
    - git remote set-url origin "https://gitlab-ci-token:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git remote -v
    - git fetch origin master
    - git branch -D master || true
    - git checkout --track origin/master
    - git pull
    - export VERSION=${CI_COMMIT_TAG}
    - echo $CI_COMMIT_TAG_MESSAGE
    - echo $CI_RELEASE_DESCRIPTION
    - PREV_TAG=$(grep -m 1 "##" docs/about/CHANGELOG.md | sed "s/## //" )
    - echo "Generating enhanced changelog for $VERSION (since $PREV_TAG)"
    # Generate enhanced changelog entry
    - python3 scripts/generate-enhanced-changelog-multiRepo.py $VERSION $PREV_TAG | sed -n '/^## /,/^---$/p' | head -n -1 > /tmp/new_entry.md
    - echo "Generated enhanced changelog entry:"
    - cat /tmp/new_entry.md
    # Update changelog with rotation (keep only last 20 entries)
    - |
      if [ $(grep -c "^## " docs/about/CHANGELOG.md) -gt 20 ]; then
        echo "Rotating old changelog entries to archive..."
        # Archive old entries (entries are preserved in git history)
        head -n $(awk '/^## /{count++} count==20{print NR-1; exit}' docs/about/CHANGELOG.md) docs/about/CHANGELOG.md > /tmp/rotated_changelog.md 2>/dev/null || cp docs/about/CHANGELOG.md /tmp/rotated_changelog.md
        mv /tmp/rotated_changelog.md docs/about/CHANGELOG.md
      fi
    # Add new entry to top of changelog
    - echo -e "# Changelog\n" > /tmp/final_changelog.md
    - cat /tmp/new_entry.md >> /tmp/final_changelog.md
    - echo "" >> /tmp/final_changelog.md
    - tail -n +3 docs/about/CHANGELOG.md >> /tmp/final_changelog.md  # Skip "# Changelog" header
    - mv /tmp/final_changelog.md docs/about/CHANGELOG.md
    - git --no-pager diff docs/about/CHANGELOG.md | head -50  # Show first 50 lines of diff
    - git add docs/about/CHANGELOG.md
    - git commit -m "Update changelog for $CI_COMMIT_TAG with enhanced analysis"
    - git --no-pager show --stat
    - git push origin master
    - cd ../
  script:
    - rm -rf waldur-mastermind || true
    - git clone "https://gitlab-ci-token:$GITLAB_TOKEN@$CI_SERVER_HOST/waldur/waldur-mastermind.git"
    - cd waldur-mastermind/
    - git tag -a $CI_COMMIT_TAG -m "$CI_COMMIT_TAG_MESSAGE"
    - git push origin $CI_COMMIT_TAG
    - cd ../
    - rm -rf waldur-homeport || true
    - git clone "https://gitlab-ci-token:$GITLAB_TOKEN@$CI_SERVER_HOST/waldur/waldur-homeport.git"
    - cd waldur-homeport/
    - git tag -a $CI_COMMIT_TAG -m "$CI_COMMIT_TAG_MESSAGE"
    - git push origin $CI_COMMIT_TAG
    - cd ../
    - rm -rf waldur-helm || true
    - git clone "https://gitlab-ci-token:$GITLAB_TOKEN@$CI_SERVER_HOST/waldur/waldur-helm.git"
    - cd waldur-helm/
    # Add new tag to Chart.yaml and values.yaml
    - |
      sed -i -E -e "s/^version: ('.*'|.*)$/version: $CI_COMMIT_TAG/" waldur/Chart.yaml
    - |
      sed -i -E -e "s/^appVersion: ('.*'|.*)$/appVersion: \"$CI_COMMIT_TAG\"/" waldur/Chart.yaml
    - |
      sed -i -E -e "s/^  imageTag: ('.*'|.*)$/  imageTag: \"$CI_COMMIT_TAG\"/" waldur/values.yaml
    - git status
    - git diff
    - git add waldur/Chart.yaml waldur/values.yaml
    - git commit -m "Set target version to ${CI_COMMIT_TAG}"
    - git push -o "ci.skip"
    - git tag -a $CI_COMMIT_TAG -m "$CI_COMMIT_TAG_MESSAGE"
    - git push origin $CI_COMMIT_TAG
    - cd ../
    - rm -rf waldur-docker-compose || true
    - git clone "https://gitlab-ci-token:$GITLAB_TOKEN@$CI_SERVER_HOST/waldur/waldur-docker-compose.git"
    - cd waldur-docker-compose/
    # Add new tag to .env.example
    - |
      sed -i -E -e "s/^WALDUR_MASTERMIND_IMAGE_TAG=('.*'|.*)$/WALDUR_MASTERMIND_IMAGE_TAG=$CI_COMMIT_TAG/" .env.example
    - |
      sed -i -E -e "s/^WALDUR_HOMEPORT_IMAGE_TAG=('.*'|.*)$/WALDUR_HOMEPORT_IMAGE_TAG=$CI_COMMIT_TAG/" .env.example
    - git status
    - git diff
    - git add .env.example
    - git commit -m "Set target version to ${CI_COMMIT_TAG}"
    - git push -o "ci.skip"
    - git tag -a $CI_COMMIT_TAG -m "$CI_COMMIT_TAG_MESSAGE"
    - git push origin $CI_COMMIT_TAG
    - cd ../
    - rm -rf waldur-prometheus-exporter || true
    - git clone "https://gitlab-ci-token:$GITLAB_TOKEN@$CI_SERVER_HOST/waldur/waldur-prometheus-exporter.git"
    - cd waldur-prometheus-exporter/
    - git tag -a $CI_COMMIT_TAG -m "$CI_COMMIT_TAG_MESSAGE"
    - git push origin $CI_COMMIT_TAG

Release Python SDK:
  image:
    name: registry.hpc.ut.ee/mirror/alpine/git:v2.49.1
    entrypoint: [""]
  stage: deploy
  rules:
    - if: '$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+$/'
  before_script: *build_before_script
  script:
    - |
      git clone git@github.com:waldur/py-client.git
      cd py-client/
      sed -i 's/^version = "[^"]*"/version = "'$CI_COMMIT_TAG'"/' pyproject.toml
      git add pyproject.toml
      git commit -m "Release: bump version to $CI_COMMIT_TAG"
      git tag -a $CI_COMMIT_TAG -m "$CI_COMMIT_TAG_MESSAGE"
      git push origin $CI_COMMIT_TAG
      git push origin main

Release TypeScript/JavaScript SDK:
  image:
    name: registry.hpc.ut.ee/mirror/alpine/git:v2.49.1
    entrypoint: [""]
  stage: deploy
  rules:
    - if: '$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+$/'
  before_script: *build_before_script
  script:
    - |
      git clone git@github.com:waldur/js-client.git
      cd js-client/
      sed -i 's/"version": "[^"]*"/"version": "'$CI_COMMIT_TAG'"/' package.json
      # Update top-level version
      sed -i '0,/"version": "[^"]*"/{s/"version": "[^"]*"/"version": "'$CI_COMMIT_TAG'"/}' package-lock.json
      # Update version in the root package object (packages[""])
      sed -i '/"packages": {/,/"devDependencies":/{s/"version": "[^"]*"/"version": "'$CI_COMMIT_TAG'"/}' package-lock.json
      git add package.json package-lock.json
      git commit -m "Release: bump version to $CI_COMMIT_TAG"
      git tag -a $CI_COMMIT_TAG -m "$CI_COMMIT_TAG_MESSAGE"
      git push origin $CI_COMMIT_TAG
      git push origin main

Release Go SDK:
  image:
    name: registry.hpc.ut.ee/mirror/alpine/git:v2.49.1
    entrypoint: [""]
  stage: deploy
  rules:
    - if: '$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+$/'
  before_script: *build_before_script
  script:
    - git clone git@github.com:waldur/go-client.git
    - cd go-client/
    - git tag -a $CI_COMMIT_TAG -m "$CI_COMMIT_TAG_MESSAGE"
    - git push origin $CI_COMMIT_TAG
    - git push origin main
